<pzm-dropdown-host
  #dropdownHostRef
  [content]="dropdown"
  [(isOpen)]="open"
  [pzmDropdownHostWidth]="dropdownWidth"
  [pzmDropdownMinHeight]="minDropdownHeight"
  [pzmDropdownMaxHeight]="maxDropdownHeight"
  *pzmLet="{ selectedItems: selectedItems$ | async, filteredItems: filteredItems$ | async } as $"
>
  <pzm-input-layout
    [label]="label"
    [forceClear]='(forceClear || forceClear === null) && $.selectedItems.length > 0'
    (clear)="focusableElementRef.focus(); safeStopPropagation(focusableElementRef.value, $event)"
    (click)="safeOpenModal()"
    [outer]="outer"
    [size]="size"
    [ngSwitch]='outer'
  >
    <input
      pzmInput
      [style.display]='outer ? "none" : ""'
      #focusableElementRef
      (onClear)="onClear()"
      [disabled]="disabled"
      [readonly]="true"
      [placeholder]="placeholder"
      [formControl]="requiredInputControl"
    />
    <div class='in-body-chips-box' pzm-input-in-body *ngSwitchCase='true'>
      <ng-container [ngTemplateOutlet]='chipsTemplate'></ng-container>
    </div>

    <ng-container pzm-input-bottom  *ngSwitchCase='false'>
      <ng-container [ngTemplateOutlet]='chipsTemplate'></ng-container>
    </ng-container>

    <ng-template #chipsTemplate>
      <ng-container *ngIf='selectedItemsChips$ | async as chips'>
        <pzm-chips
          *ngIf='chips.length'
          #chipsComponent
          [class.inner]='!outer'
          [singleLine]='true'
          [deletable]='isChipsDeletable'
          [chips]="chips"
          (removeChipEvent)="removeChip($event)"
        ></pzm-chips>
      </ng-container>
    </ng-template>


    <pzm-icon
      *ngIf="!disabled"
      (click)="focusableElementRef.focus()"
      [class.active]="focusableElementRef.focused"
      [class.opened]="open"
      class="icon-dropdown"
      pzm-input-right
      iconClass="chevrons-dropdown"
    ></pzm-icon>
  </pzm-input-layout>

  <ng-template #dropdown>
    <pzm-data-list class="block" [style.--pzm-data-list-border]='0'>
      <div class="list-search-item" *ngIf="searchable">
        <pzm-input-layout size="m" label="Поиск">
          <input pzmInput pzmAutoFocus class="input-search" #input [formControl]="searchInputControl" />
          <button pzmInputIconButton="sort-zoom-in" pzm-input-right [interactive]="true"></button>
        </pzm-input-layout>
      </div>
      <ng-container *ngIf="$.filteredItems?.length; else emptyTemplate">
        <div
          class="item"
          [class.selected]="item.checked"
          [class.most-relevant]="searchable && searchInputControl.value && idx === 0"
          *ngFor="let item of $.filteredItems; let idx = index"
          #parent
        >
          <pzm-checkbox
            [checked]="item.checked"
            [host]='parent'
            [indeterminate]='!!item.indeterminate'
            (changed)='select(item)'>
            <div class="text"
                  #elem
                  *pzmLet="item | pzmCallFunc: stringify:$any(emptyContent) as text"
                  [pzmHint]='text'
                  [pzmHintDirection]='direction'
                  [pzmHintCanShow]='elem | pzmCallFunc : pzmIsTextOverflow$ | async'
            >
              <ng-container
                *polymorphOutlet="
                  valueTemplate as content;
                  context: {
                    $implicit: {
                      obj: item.obj,
                      checked: item.checked,
                      stringify: item | pzmCallFunc: stringify
                    }
                  } as context
                "
              >
                {{ text }}
              </ng-container>
            </div>
          </pzm-checkbox>
        </div>
      </ng-container>
      <ng-template #emptyTemplate>
        <ng-container *polymorphOutlet="emptyContent as data">
          <div class="empty-template">{{ emptyContent }}</div>
        </ng-container>
      </ng-template>
    </pzm-data-list>
  </ng-template>
</pzm-dropdown-host>

