<pzm-dropdown-host
  #dropdownHostRef
  [content]="dropdown"
  [(isOpen)]="open"
  [pzmDropdownHostWidth]='dropdownWidth'
  [pzmDropdownMinHeight]='minDropdownHeight'
  [pzmDropdownMaxHeight]='maxDropdownHeight'
  *pzmLet='filteredItems$ | async as items'
>
  <pzm-input-layout
    [label]="label"
    [forceClear]='forceClear'
    (click)='safeOpenModal()'
    (clear)='safeStopPropagation(focusableElementRef.value, $event);'
    [outer]='outer'
    [size]="size">
    <input
      class='input-search'
      pzmInput
      #focusableElementRef
      (onClear)='onClear()'
      [placeholder]="placeholder"
      [disabled]='!searchable || this.disabled'
      [readonly]='!searchable || this.disabled'
      [formControl]="requiredInputControl"
    />
    <pzm-icon *ngIf='!disabled'
              (click)='focusableElementRef.focus()'
              [class.opened]="open"
              [class.active]='focusableElementRef.focused'
              class='icon-dropdown' pzm-input-right iconClass='chevrons-dropdown'></pzm-icon>
  </pzm-input-layout>

  <ng-template #dropdown>
    <pzm-data-list class='block' [style.--pzm-data-list-border]='0'>
      <ng-container *ngIf='items?.length; else emptyTemplate'>
        <div class='item'
             [class.most-relevant]="searchable && focusableElementRef.value && ((!items[0] && idx === 1) || idx === 0)"
             [class.selected]='item && value && (item | pzmCallFunc : identityMatcher : value)'
             #hostHint
             *ngFor='let item of filteredItems$ | async; let idx = index'
             (click)='select(item)'
        >
          <ng-container *ngIf='item; else nullContentTemplate'>
            <span class='text'
                  #elem
                  *pzmLet='item | pzmCallFunc : stringify : $any(nullContent) as text'
                  [pzmHint]='text'
                  [pzmHintHost]='hostHint'
                  [pzmHintDirection]='direction'
                  [pzmHintCanShow]='elem | pzmCallFunc : pzmIsTextOverflow$ | async'
            >
              <ng-container *polymorphOutlet="
                valueTemplate as content;
                context: {
                  $implicit: item,
                  stringify: text
                }">
                {{text}}
              </ng-container>
            </span>
          </ng-container>

          <ng-template #nullContentTemplate>
            <ng-container *ngIf='!requiredInputControl.value'>
              <ng-container *polymorphOutlet="
                nullContent as content;">
                {{content}}
              </ng-container>
            </ng-container>
          </ng-template>
        </div>
      </ng-container>
      <ng-template #emptyTemplate>
        <div class='empty-template'>
          <ng-container *polymorphOutlet="
              emptyContent as content;">
            {{content}}
          </ng-container>
        </div>
      </ng-template>
    </pzm-data-list>
  </ng-template>
</pzm-dropdown-host>
